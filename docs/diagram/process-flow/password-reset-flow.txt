# User Management - Password Reset Flow (ASCII)

```
╔════════════════════════════════════════════════════════════════════════════════╗
║                         PASSWORD RESET PROCESS FLOW                             ║
╚════════════════════════════════════════════════════════════════════════════════╝


                              ┌─────────────┐
                              │   START     │
                              │   (User)    │
                              └──────┬──────┘
                                     │
                                     ▼
                          ┌──────────────────────┐
                          │  User at Login page  │
                          │  but forgot password │
                          └──────────┬───────────┘
                                     │
                                     ▼
                          ┌──────────────────────┐
                          │  Click "Forgot       │
                          │  Password?" link     │
                          └──────────┬───────────┘
                                     │
                                     ▼
                ┌────────────────────────────────────────┐
                │  Navigate to Password Reset page       │
                │  ┌──────────────────────────────────┐  │
                │  │ Forgot Your Password?            │  │
                │  │                                  │  │
                │  │ Enter your email address and    │  │
                │  │ we'll send you a link to reset  │  │
                │  │ your password.                   │  │
                │  │                                  │  │
                │  │ Email: [_________________]       │  │
                │  │                                  │  │
                │  │ [Send Reset Link]                │  │
                │  └──────────────────────────────────┘  │
                └──────────────────┬─────────────────────┘
                                   │
                                   ▼
                          ┌─────────────────────┐
                          │  User enters email  │
                          │  and submits        │
                          └──────────┬──────────┘
                                     │
                                     ▼
                          ┌──────────────────────┐
                          │  Frontend validation │
                          │  (email format)      │
                          └──────────┬───────────┘
                                     │
                       ┌─────────────┴─────────────┐
                       │                           │
                  [Valid?]                    [Invalid?]
                       │                           │
                   ┌───▼───┐                   ┌───▼───┐
                   │  YES  │                   │  NO   │
                   └───┬───┘                   └───┬───┘
                       │                           │
                       │                           ▼
                       │              ┌────────────────────────┐
                       │              │  Show error message    │
                       │              │  "Invalid email format"│
                       │              └────────────┬───────────┘
                       │                           │
                       │              ┌────────────┘
                       │              │
                       ▼              ▼
            ┌──────────────────────────────┐
            │  POST /api/forgot-password   │
            │  {                           │
            │    email: "user@dict.gov.ph" │
            │  }                           │
            └──────────────┬───────────────┘
                           │
                           ▼
            ┌──────────────────────────────┐
            │  BACKEND: Validate Request   │
            └──────────────┬───────────────┘
                           │
                           ▼
            ┌──────────────────────────────┐
            │  Check if user exists        │
            │  with this email             │
            └──────────────┬───────────────┘
                           │
              ┌────────────┴────────────┐
              │                         │
         [Exists?]                  [Not found?]
              │                         │
          ┌───▼───┐                     │
          │  YES  │                     │
          └───┬───┘                     │
              │                         │
              │                         │
              ▼                         │
   ┌──────────────────────┐             │
   │  Check if account    │             │
   │  is active           │             │
   └──────────┬───────────┘             │
              │                         │
 ┌────────────┴────────────┐            │
 │                         │            │
[Active?]             [Inactive?]       │
 │                         │            │
┌▼──┐                  ┌───▼───┐        │
│YES│                  │  NO   │        │
└┬──┘                  └───┬───┘        │
 │                         │            │
 │                         │            │
 │       ┌─────────────────┴────────────┘
 │       │
 │       │ (Security: Always return success to prevent email enumeration)
 │       │
 ▼       ▼
┌────────────────────────────────┐
│ Return 200 OK (regardless)     │
│ {                              │
│   success: true,               │
│   message: "If an account      │
│            exists with that    │
│            email, you will     │
│            receive a password  │
│            reset link"         │
│ }                              │
└────────┬───────────────────────┘
         │
         │ (Only if user exists and is active)
         │
         ▼
┌────────────────────────────┐
│ Generate unique reset token│
│ (60 random characters)     │
└────────────┬───────────────┘
             │
             ▼
┌────────────────────────────┐
│ Hash token for storage     │
└────────────┬───────────────┘
             │
             ▼
┌────────────────────────────┐
│ Store in                   │
│ password_reset_tokens:     │
│ - email                    │
│ - hashed token             │
│ - expires_at (1 hour)      │
└────────────┬───────────────┘
             │
             ▼
┌────────────────────────────┐
│ Delete any existing tokens │
│ for this email             │
└────────────┬───────────────┘
             │
             ▼
┌────────────────────────────┐
│ Generate reset URL:        │
│ [app_url]/reset-password   │
│   ?token=[plain_token]     │
│   &email=[email]           │
└────────────┬───────────────┘
             │
             ▼
┌────────────────────────────┐
│ Queue password reset email │
└────────────┬───────────────┘
             │
             ▼
┌────────────────────────────┐
│ Log password reset request │
└────────────┬───────────────┘
             │
             ▼
    ┌────────────────┐
    │ Frontend shows │
    │ success message│
    └────────┬───────┘
             │
             ▼
┌──────────────────────────────────┐
│ Display Message:                 │
│ ┌──────────────────────────────┐ │
│ │ ✉️ Check Your Email          │ │
│ │                              │ │
│ │ If an account exists with    │ │
│ │ that email address, you will │ │
│ │ receive a password reset link│ │
│ │ shortly.                     │ │
│ │                              │ │
│ │ The link will expire in 1 hr │ │
│ │                              │ │
│ │ [Back to Login]              │ │
│ └──────────────────────────────┘ │
└──────────────┬───────────────────┘
               │
               ▼
       ┌──────────────┐
       │ MEANWHILE... │
       └──────┬───────┘
              │
              ▼
┌─────────────────────────────────────┐
│ EMAIL SENDING (Background)          │
│ ┌─────────────────────────────────┐ │
│ │ To: user@dict.gov.ph            │ │
│ │ Subject: Password Reset Request │ │
│ │                                 │ │
│ │ Dear User,                      │ │
│ │                                 │ │
│ │ You requested to reset your     │ │
│ │ password. Click the link below: │ │
│ │                                 │ │
│ │ [Reset Password Button/Link]   │ │
│ │                                 │ │
│ │ This link will expire in 1 hour│ │
│ │                                 │ │
│ │ If you didn't request this,    │ │
│ │ please ignore this email.       │ │
│ │                                 │ │
│ │ For security, never share this  │ │
│ │ link with anyone.               │ │
│ └─────────────────────────────────┘ │
└────────────┬────────────────────────┘
             │
             ▼
┌────────────────────────────┐
│ User receives email        │
└────────────┬───────────────┘
             │
             ▼
┌────────────────────────────┐
│ User clicks reset link     │
└────────────┬───────────────┘
             │
             ▼
┌────────────────────────────────────┐
│ Navigate to Reset Password page    │
│ with token and email as params     │
└────────────┬───────────────────────┘
             │
             ▼
┌────────────────────────────┐
│ GET /reset-password        │
│ ?token=xxx&email=yyy       │
└────────────┬───────────────┘
             │
             ▼
┌────────────────────────────┐
│ Backend validates token:   │
│ - Token exists in DB       │
│ - Not expired              │
│ - Email matches            │
└────────────┬───────────────┘
             │
   ┌─────────┴─────────┐
   │                   │
[Valid?]          [Invalid?]
   │                   │
┌──▼──┐            ┌───▼───┐
│ YES │            │  NO   │
└──┬──┘            └───┬───┘
   │                   │
   │                   ▼
   │      ┌────────────────────────┐
   │      │ Show error page:       │
   │      │ "Invalid or expired    │
   │      │  reset link"           │
   │      │ [Request New Link]     │
   │      └────────────────────────┘
   │
   ▼
┌──────────────────────────────────┐
│ Display Password Reset Form      │
│ ┌──────────────────────────────┐ │
│ │ Create New Password          │ │
│ │                              │ │
│ │ New Password:                │ │
│ │ [_______________]            │ │
│ │                              │ │
│ │ Confirm Password:            │ │
│ │ [_______________]            │ │
│ │                              │ │
│ │ Requirements:                │ │
│ │ • Min 8 characters           │ │
│ │ • Uppercase & lowercase      │ │
│ │ • At least one number        │ │
│ │ • At least one special char  │ │
│ │                              │ │
│ │ [Reset Password]             │ │
│ └──────────────────────────────┘ │
└──────────────┬───────────────────┘
               │
               ▼
    ┌─────────────────────┐
    │ User enters new     │
    │ password and submits│
    └─────────┬───────────┘
              │
              ▼
    ┌──────────────────────────────┐
    │ POST /api/reset-password     │
    │ {                            │
    │   email: "user@dict.gov.ph"  │
    │   token: "xxx",              │
    │   password: "NewPass123!",   │
    │   password_confirmation: "..." 
    │ }                            │
    └──────────┬───────────────────┘
               │
               ▼
    ┌──────────────────────┐
    │ Backend validates:   │
    │ - Token still valid  │
    │ - Password rules met │
    │ - Passwords match    │
    └──────────┬───────────┘
               │
      ┌────────┴────────┐
      │                 │
  [Valid?]        [Invalid?]
      │                 │
  ┌───▼───┐         ┌───▼───┐
  │  YES  │         │  NO   │
  └───┬───┘         └───┬───┘
      │                 │
      │                 ▼
      │    ┌─────────────────────┐
      │    │ Return 422          │
      │    │ Validation errors   │
      │    └─────────────────────┘
      │
      ▼
┌──────────────────────┐
│ Hash new password    │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ Update user:         │
│ - password           │
│ - password_changed_at│
│ - force_change=false │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ Delete reset token   │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ Invalidate all       │
│ active sessions      │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ Send confirmation    │
│ email (password      │
│ changed successfully)│
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ Log password change  │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ Return 200 OK        │
│ {                    │
│   success: true,     │
│   message: "Password │
│            reset     │
│            successful"│
│ }                    │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────────────┐
│ Frontend: Show success       │
│ message and redirect to login│
└──────────┬───────────────────┘
           │
           ▼
   ┌────────────────┐
   │ User can now   │
   │ login with new │
   │ password       │
   └────────┬───────┘
            │
            ▼
       ┌─────────┐
       │   END   │
       └─────────┘


═══════════════════════════════════════════════════════════════════════════════
SECURITY MEASURES:
═══════════════════════════════════════════════════════════════════════════════

1. TOKEN SECURITY:
   • Token is 60 random characters
   • Token is hashed before storage (SHA-256)
   • Token expires after 1 hour
   • Token can only be used once
   • Old tokens deleted when new request made

2. EMAIL ENUMERATION PREVENTION:
   • Always return success message
   • Don't reveal if email exists or not
   • Same response time regardless

3. RATE LIMITING:
   • Max 5 reset requests per email per hour
   • Max 3 attempts per IP per minute
   • Temporary block after excessive requests

4. PASSWORD VALIDATION:
   • Minimum 8 characters
   • Mixed case required
   • Numbers required
   • Special characters required
   • Cannot be same as old password
   • Cannot be common password

5. SESSION INVALIDATION:
   • All existing sessions terminated
   • User must login again everywhere
   • Prevents unauthorized access

6. AUDIT TRAIL:
   • All reset requests logged
   • Password changes logged
   • IP addresses tracked
   • Suspicious activity flagged

═══════════════════════════════════════════════════════════════════════════════
CONFIRMATION EMAIL TEMPLATE:
═══════════════════════════════════════════════════════════════════════════════

Subject: Password Changed Successfully

Dear [Name],

Your password has been changed successfully.

Details:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Date/Time: [timestamp]
IP Address: [ip_address]
Device: [user_agent]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

If you did NOT make this change, please contact the IT department
immediately as your account may have been compromised.

Best regards,
DICT IT Team

═══════════════════════════════════════════════════════════════════════════════
ERROR SCENARIOS:
═══════════════════════════════════════════════════════════════════════════════

1. Token Expired:
   • Show message: "Reset link has expired"
   • Offer to resend reset link

2. Token Already Used:
   • Show message: "Reset link already used"
   • Offer to request new link

3. Invalid Token:
   • Show message: "Invalid reset link"
   • Redirect to forgot password page

4. Password Too Weak:
   • Show validation errors
   • Highlight requirements not met

5. Rate Limit Exceeded:
   • Show message: "Too many requests"
   • Display wait time

═══════════════════════════════════════════════════════════════════════════════
```

